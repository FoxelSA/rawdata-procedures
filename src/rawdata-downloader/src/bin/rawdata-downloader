#!/bin/bash

_UID=$UID
_GID=1000

SCRIPT=$(basename $0)

log() {
  echo $(date +%F_%r) $SCRIPT $BASHPID $@ >&2
}

# format stdin for logginG
logstdout() {
  while read l ; do
    echo $(date +%F_%R:%S) $SCRIPT $BASHPID $@ $l >&2
  done
}

DESTINATION=$1

[ -z "$DESTINATION" ] && exit 1

# download rawdata from camera modules
DEST=$(rawdata-download $DESTINATION)
EXIT_CODE=$?
if [ $EXIT_CODE -ne 0 ] ; then
 log ${LINENO} rawdata-download exit code $EXIT_CODE
 exit $EXIT_CODE
fi


firsttimestamp() {
  find $1 |
  grep -E -e '\/[0-9_]{17}' |
  while read f ; do
    b=$(basename $f)
    echo ${b:0:10}
  done |
  sort -u |
  head -n 1
}

# get first timestamp in rsync folder
TIMESTAMP=$(firsttimestamp $DEST/rsync)

if [ -z "$TIMESTAMP" ] ; then
  log ${LINENO} first timestamp not found
  exit 1
fi

# move files
if ! rsync -av --remove-source-files --chmod=u+w,a+rX $DEST/rsync/ $DEST/raw/sync/$TIMESTAMP/ 2>&1 | logstdout ${LINENO} ; then
  exit 1
fi

# remove remaining source files
rm /$DEST/rsync -r

# set permissions for directories
chown $_UID.$_GID $DEST/raw $DEST/raw/sync/$TIMESTAMP
chmod 0775 $DEST/raw $DEST/raw/sync/$TIMESTAMP

# return mac address and first timestamp
echo $(basename $DEST) $TIMESTAMP

